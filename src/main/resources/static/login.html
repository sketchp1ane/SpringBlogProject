<!DOCTYPE html>
<html lang="zh">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>javaweb期末作业 - 登录</title>
   <!-- Bootstrap CSS -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   <style>
      .nav-item {
         border: 2px solid rgba(255, 255, 255, 0);
         border-radius: 10px;
         transition: border 0.3s, transform 0.3s;
      }
      .nav-item:hover {
         border: 2px solid rgba(255, 255, 255, 100);
         border-radius: 10px;
         transform: scale(1.2);
      }

      .navbar-brand {
         transition: transform 0.3s;
      }

      .navbar-brand:hover {
         transform: scale(2);
      }
   </style>
   <script>
      document.addEventListener('DOMContentLoaded', function () {
         // 检查用户是否已登录
         fetch('/api/user/login/status')
                 .then(response => response.json())
                 .then(isLoggedIn => {
                    if (isLoggedIn) {
                       // 如果用户已登录，隐藏登录表单，显示“已登录”信息
                       document.getElementById('loginForm').style.display = 'none';
                       document.getElementById('loggedInMessage').style.display = 'block';

                       // 获取用户邮箱并显示
                       fetch('/api/user/email')
                               .then(response => response.text())
                               .then(email => {
                                  document.getElementById('userEmail').textContent = email;
                               });
                    } else {
                       // 如果用户未登录，显示登录表单
                       document.getElementById('loginForm').style.display = 'block';
                       document.getElementById('loggedInMessage').style.display = 'none';
                    }
                 });

         // 处理登录表单提交
         document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault(); // 阻止默认的表单提交

            const formData = new FormData(this);
            fetch('/api/user/login', {
               method: 'POST',
               body: formData
            })
                    .then(response => {
                       if (response.ok) {
                          // 登录成功，重定向到主页
                          window.location.href = '/index.html';
                       } else {
                          // 登录失败，显示错误信息
                          document.getElementById('errorAlert').style.display = 'block';
                       }
                    })
                    .catch(error => {
                       console.error('登录时出错:', error);
                       document.getElementById('errorAlert').style.display = 'block';
                    });
         });

         // 处理登出功能
         document.getElementById('logoutButton').addEventListener('click', function () {
            fetch('/logout', { method: 'POST' })
                    .then(response => {
                       if (response.ok) {
                          window.location.href = '/login.html'; // 登出后重定向到登录页面
                       } else {
                          console.error('登出失败');
                       }
                    })
                    .catch(error => console.error('登出时出错:', error));
         });
      });
   </script>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg bg-primary" style="z-index: 1;">
   <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
         <img src="images/schoolLogo.jpg" width="30" height="30" style="border-radius: 50%;">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
         <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
         <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
               <a class="nav-link active" aria-current="page" href="index.html">首页</a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="author.html">作者介绍</a>
            </li>
            <li class="nav-item dropdown">
               <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  家乡介绍
               </a>
               <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="homeland.html#homeland_food">家乡美食</a></li>
                  <li><a class="dropdown-item" href="homeland.html#homeland_sight">家乡景点</a></li>
                  <li><a class="dropdown-item" href="homeland.html#homeland_culture">家乡文化</a></li>
               </ul>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="forum.html">留言板</a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="query.html">查询</a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="login.html">登录</a>
            </li>
            <li class="nav-item">
               <a class="nav-link" href="account_set.html">账号管理</a>
            </li>
         </ul>
         <form class="d-flex" role="search">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-dark" type="submit">Search</button>
         </form>
      </div>
   </div>
</nav>

<!-- 登录表单 -->
<div class="container mt-5 mb-4">
   <div class="row justify-content-center">
      <div class="col-md-6">
         <div class="card">
            <div class="card-body">
               <h1 class="card-title text-center mb-4">登录</h1>

               <!-- 登录表单，POST到Spring Security的默认/login处理器 -->
               <form id="loginForm" method="post">
                  <div class="mb-3">
                     <label for="inputEmail" class="form-label">邮箱地址</label>
                     <input type="email" class="form-control" id="inputEmail" name="username"
                            placeholder="请输入您的邮箱地址" required>
                  </div>
                  <div class="mb-3">
                     <label for="inputPassword" class="form-label">密码</label>
                     <input type="password" class="form-control" id="inputPassword" name="password"
                            placeholder="请输入您的密码" required>
                  </div>
                  <div class="mb-3 form-check">
                     <input type="checkbox" class="form-check-input" id="rememberMe" name="remember-me">
                     <label class="form-check-label" for="rememberMe">记住我</label>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">登录</button>
               </form>

               <!-- 已登录时显示的内容 -->
               <div id="loggedInMessage" style="display: none;">
                  <h2 class="text-center">你已登录！</h2>
                  <p class="text-center">当前用户邮箱：<span id="userEmail"></span></p>
                  <div class="text-center">
                     <button id="logoutButton" class="btn btn-danger">登出</button>
                  </div>
               </div>

               <div id="errorAlert" class="alert alert-danger mt-3" role="alert" style="display: none;">
                  账号或密码错误，登录失败，请重试。
               </div>
               <p class="mt-3 text-center">还没有账号？<a href="signup.html">注册一个</a></p>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

</body>
</html>
